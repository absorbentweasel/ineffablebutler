var muniButlerApp=angular.module("muniButler",["ngMap","ngResource","ngRoute","ngMaterial"]).config(function(a,b){b.defaults.withCredentials=!0,a.when("/",{templateUrl:"views/home.html",controller:"HomeController"}).when("/routes",{templateUrl:"views/routes.html",controller:"RoutesController"}).when("/login",{templateUrl:"views/login.html",controller:""}).otherwise({redirectTo:"/"})});muniButlerApp.factory("Auth",function(a){var b=function(){return a.get("/api/user",{withCredentials:!0})},c=function(b){return console.log("user: ",b),a.put("/api/user",b,{withCredentials:!0})},d=function(){return a.get("/api/logout",{withCredentials:!0})};return{check:b,logout:d,update:c}}),muniButlerApp.factory("User",function(a){var b={};return b.routes=[],b.trip={from:"",to:""},b.addRoute=function(c){var d={id:b.routes.length,from:c.from,to:c.to,route:c.route};return b.routes.push(d),console.log("route",a),b.id&&(console.log("adding route"),a.update(b)),d},b.removeRoute=function(c){var d=b.routes.splice(c,1);return b.id&&a.update(b),d},b}),muniButlerApp.factory("Autocomplete",function(){var a=function(a){var b=new google.maps.places.Autocomplete(document.getElementsByClassName("autocomplete")[0]),c=new google.maps.places.Autocomplete(document.getElementsByClassName("autocomplete")[1]);google.maps.event.addListener(b,"place_changed",function(){a.user.from=b.getPlace().formatted_address}),google.maps.event.addListener(c,"place_changed",function(){a.user.to=c.getPlace().formatted_address})};return{initialize:a}}),muniButlerApp.factory("GoogleMaps",function(a){var b={};return b.getDirectionsRequestObject=function(a,b){var c={origin:a,destination:b,travelMode:google.maps.TravelMode.TRANSIT,transitOptions:{modes:[google.maps.TransitMode.BUS]},unitSystem:google.maps.UnitSystem.IMPERIAL,durationInTraffic:!0,provideRouteAlternatives:!0,avoidHighways:!1,avoidTolls:!1};return c},b.createDirectionsService=function(){var a=new google.maps.DirectionsService;return a},b.createDirectionsRendererObject=function(){var a=new google.maps.DirectionsRenderer;return a},b}),muniButlerApp.factory("FiveEleven",function(a,b){var c={};return c.APItoken="e04385aa-cdb9-4f5b-9d78-9c7e0dcb7260",c.APIEndpoints={nextDepartures:function(a){return"http://services.my511.org/Transit2.0/GetNextDeparturesByStopCode.aspx?token="+c.APItoken+"&stopCode="+a}},c.getNextBustTimes=function(a,b){var c=[],d=function(a){if(console.log(a),a.getAttribute("Code")!==b){if(a.childNodes)for(var e=0;e<a.childNodes.length;e++)d(a.childNodes[e])}else for(var f=a.childNodes[0],g=f.childNodes[0],h=g.childNodes[0],i=0;i<h.childNodes.length;i++)c.push(h.childNodes[e].childNodes[0])};return d(a),c},c}),muniButlerApp.controller("LogController",function(a,b,c){console.log("in LogController"),a.here=!1,a.loggedin=!1,a.options=[],a.logout=function(){b.logout().then(function(b){return console.log("logged out"),a.loggedin=!1,a.login()})["catch"](function(a){console.log(a)})},a.login=function(){b.check().then(function(b){console.log("logged in"),a.loggedin=!0,c.displayName=b.data.displayName,c.id=b.data.id,c.routes=b.data.routes})["catch"](function(b){a.options=b.data.authMethods})},a.login()}),muniButlerApp.controller("HomeController",function(a,b,c,d,e,f){function g(b){var c,d=new google.maps.Geocoder,e=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);d.geocode({location:e},function(b,d){d==google.maps.GeocoderStatus.OK&&(c=b[0].formatted_address,a.user.from=c,a.$apply())}),a.setMap(e)}function h(){console.log("Geolocation failed"),a.setMap(new google.maps.LatLng(37.7837235,-122.4089778))}a.enter=!1,a.newroute=!1,a.msg="Add new route!",a.setMap=function(a){var b=e.createDirectionsRendererObject(),c={zoom:18,center:a},d=new google.maps.Map(document.getElementById("routes-map"),c);b.setMap(d)},a.msgChange=function(){a.newroute?a.msg="Cancel":a.msg="Add new route!"},a.user={from:"Finding current location..."},navigator.geolocation&&navigator.geolocation.getCurrentPosition(g,h),a.submit=function(d){console.log("in submit funciton"),d&&(b.trip={to:a.user.to,from:a.user.from},c.path("/routes"))},a.routes=b.routes,d.initialize(a)}),muniButlerApp.controller("RoutesController",function(a,b,c,d,e,f){a.user={},a.user.trip=d.trip,a.user.routeHeading=d.routeHeading,a.user.going=!0,a.user.routeHeading="Departure Route",a.user.returning=!1,a.user.routeOptions,a.user.route={from:d.trip.from,to:d.trip.to,route:""},a.user.route.to&&a.user.route.from||c.path("/"),a.user.getRouteBack=function(){a.user.getRouteOptions(d.trip.to,d.trip.from)},a.user.selectRoute=function(b,e){console.log(b,e),a.user.going&&!a.user.returning?(a.user.routeHeading="Departure Route",a.user.route.route=[b,e],d.addRoute(a.user.route),a.user.routeHeading="Return Route",a.user.going=!1,a.user.returning=!0,a.user.getRouteBack()):!a.user.going&&a.user.returning&&(a.user.route.route=[b,e],d.addRoute(a.user.route),a.user.returning=!1,a.user.going=!0,c.path("/"))},a.user.getRouteOptions=function(b,c){var d=e.createDirectionsService(),f=e.getDirectionsRequestObject(b,c),g=e.createDirectionsRendererObject(),h={zoom:18,center:new google.maps.LatLng(37.783724,-122.408978)},i=new google.maps.Map(document.getElementById("routes-map"),h);g.setMap(i),d.route(f,function(b,c){if("OK"===!c)throw c;g.setDirections(b);var d={};d.numRoutes=b.routes.length,d.routes=[];for(var e=0;e<b.routes.length;e++){var f={};f.lines=[],f.duration=b.routes[e].legs[0].duration.text;var h=b.routes[e].legs[0].steps;for(var i in h)if("TRANSIT"===h[i].travel_mode){var j=b.routes[e].legs[0].steps[i].transit.line.short_name,k=b.routes[e].legs[0].steps[i].transit.departure_stop.name;f.lines.push([j,k])}d.routes.push(f)}a.user.routeOptions=d,a.$apply(),console.log(a.user.routeOptions)})},a.user.getRouteOptions(d.trip.from,d.trip.to)});